<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JW Shepherd</title>

    <link rel="manifest" href="manifest.json">
    
    <link rel="icon" type="image/png" href="icons/icon-192x192.png">

    <meta name="theme-color" content="#5B3C88">

    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@500&family=Nunito:wght@700&display=swap" rel="stylesheet">
    
    <style>
        body {
            /* Impostato il nuovo font per tutta l'app */
            font-family: 'Comfortaa', sans-serif;
        }
        .font-nunito {
            /* Mantenuto il font Nunito per il titolo */
            font-family: 'Nunito', sans-serif;
        }
        :root {
            --brand-color: #5B3C88;
            --brand-color-dark: #4a2f6e;
            --brand-color-darker: #3a2455;
            --brand-color-light: #e9e4f0;
            --brand-color-lighter: #f4f1f8;
            --brand-text-color: var(--brand-color);
            --brand-text-hover: var(--brand-color-dark);
        }
        .note-content p { margin-bottom: 0.5rem; }
        .note-content ul, .note-content ol { padding-left: 1.5rem; margin-bottom: 0.5rem; }
        .note-content strong { font-weight: bold; }
        .note-content em { font-style: italic; }
        .note-content u { text-decoration: underline; }
        .ql-editor { min-height: 100px; }

        /* Animazione per attività imminenti */
        @keyframes glowing {
            0% { box-shadow: 0 0 3px var(--brand-color); }
            50% { box-shadow: 0 0 10px 3px var(--brand-color-light); }
            100% { box-shadow: 0 0 3px var(--brand-color); }
        }
        .glowing-activity {
            animation: glowing 2s infinite ease-in-out;
            border-color: var(--brand-color);
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
    
    <script type="text/babel" data-presets="react,es2015">
        // Importa le dipendenze
        const { useState, useEffect, useCallback, useRef } = React;
       
        // --- INIZIO DEL CODICE APP ---
        
        // --- DATI DI ESEMPIO (MOCK DATA) ---
        const MOCK_DATA = {
            families: [
                { id: 'f1', name: 'Famiglia Rossi', address: 'Via Roma, 1', notes: 'Note sulla <b>famiglia Rossi</b>.' },
                { id: 'f2', name: 'Famiglia Bianchi', address: 'Via Milano, 10', notes: 'Hanno bisogno di incoraggiamento.' }
            ],
            group_members: [
                { id: 'm1', familyId: 'f1', fullName: 'Mario Rossi', role: 'Capofamiglia', phone: '333-1112233', email: 'mario.rossi@example.com', tags: ['anziano', 'pioniere'] },
                { id: 'm2', familyId: 'f1', fullName: 'Giulia Rossi', role: 'Moglie', phone: '333-4445566', email: 'giulia.rossi@example.com', tags: ['pioniere'] },
                { id: 'm3', familyId: 'f2', fullName: 'Luca Bianchi', role: 'Capofamiglia', phone: '344-7778899', email: 'luca.bianchi@example.com', tags: [] }
            ],
            visits: [
                { id: 'v1', familyId: 'f1', familyName: 'Famiglia Rossi', date: new Date(Date.now() + 2 * 60 * 1000).toISOString(), category: 'Incoraggiamento', topic: 'Perseveranza', scriptures: 'Romani 5:3-5', notes: 'Visita molto positiva.', completed: false },
                { id: 'v2', familyId: 'f2', familyName: 'Famiglia Bianchi', date: new Date().toISOString(), category: 'Incoraggiamento', topic: 'Uso del sito jw.org', scriptures: '', notes: 'Hanno apprezzato i suggerimenti.', completed: true, recurring: 'semestrale', endDate: new Date('2026-12-31').toISOString() }
            ],
            reminders: [
                { id: 'r1', date: new Date(Date.now() + 1 * 24 * 60 * 60 * 1000).toISOString(), text: 'Chiamare Fratello Verdi', priority: 'Alta', recurring: 'Nessuna', completed: false },
                { id: 'r2', date: new Date().toISOString(), text: 'Preparare lo schema per la visita', priority: 'Media', recurring: 'Nessuna', completed: true }
            ],
            toolbox: [
                { id: 't1', title: 'Articolo sull\'ospitalità', url: 'https://www.jw.org/it/biblioteca-digitale/riviste/g201503/ospitalita/', description: 'Come mostrare ospitalità in modo pratico.' }
            ],
            messages: [
                { id: 'c1', type: 'Promemoria adunanza infrasettimanale', text: 'Ricordiamo l\'adunanza di questa settimana. Non mancate!' }
            ],
            links: [
                { id: 'l1', name: 'JW.ORG', url: 'https://www.jw.org' },
                { id: 'l2', name: 'JW Broadcasting', url: 'https://tv.jw.org' }
            ]
        };

        const LOCAL_STORAGE_KEY = 'jw-shepherd-data';

        // --- ICONE SOSTITUTIVE ---
        const Icon = ({ name, size = 18 }) => {
            const iconMap = {
                Home: '🏠', 
                Users: '👨‍👩‍👧‍👦', 
                CalendarCheck: '📅', 
                MessageSquareText: '✉️', 
                ListTodo: '🔔', 
                Briefcase: '🧰', 
                Link: '🔗', 
                Settings: '⚙️', 
                Menu: '☰', 
                X: '✕', 
                Plus: '➕', 
                Edit: '✏️', 
                Trash2: '🗑️', 
                Copy: '📋', 
                CheckCircle: '✔️', 
                Circle: '⚪', 
                BookOpen: '📖', 
                DatabaseZap: '⚡', 
                Download: '💾', 
                ChevronDown: '▼', 
                ChevronUp: '▲', 
                Phone: '📞', 
                Mail: '📧', 
                Lock: '🔒', 
                Bell: '🔔',
                Repeat: '🔄',
                RotateCcw: '↩️',
                Save: '💾'
            };
            return <span style={{ fontSize: `${size}px`, display: 'inline-block' }} className="flex-shrink-0">{iconMap[name] || '❓'}</span>
        };
        
        // --- COMPONENTI PRINCIPALI ---
        const App = () => {
            const [currentPage, setCurrentPage] = useState('dashboard');
            const [appData, setAppData] = useState(() => {
                const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
                try {
                    if (savedData) return JSON.parse(savedData);
                } catch (e) {
                    console.error("Errore nel caricamento dei dati salvati:", e);
                }
                return MOCK_DATA;
            });
            const [saveStatus, setSaveStatus] = useState('Salvato');
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);
        
            const navigateTo = (page) => {
                setCurrentPage(page);
                setIsSidebarOpen(false); 
            }

            useEffect(() => {
                setSaveStatus('Modifiche non salvate');
                const handler = setTimeout(() => {
                    handleSave();
                }, 2000); 

                return () => {
                    clearTimeout(handler);
                };
            }, [appData]);

            const handleSave = () => {
                setSaveStatus('Salvataggio...');
                try {
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(appData));
                    setTimeout(() => setSaveStatus('Salvato'), 500);
                } catch (e) {
                    console.error("Errore nel salvataggio dei dati:", e);
                    setSaveStatus('Errore');
                }
            };
        
            return (
                <>
                    <NotificationManager data={appData} />
                    <div className="bg-gray-100 font-sans min-h-screen">
                        <Sidebar 
                            currentPage={currentPage} 
                            navigateTo={navigateTo} 
                            isSidebarOpen={isSidebarOpen} 
                            setIsSidebarOpen={setIsSidebarOpen}
                            isCollapsed={isSidebarCollapsed}
                            onToggleCollapse={setIsSidebarCollapsed}
                        />
                        <div className={`relative transition-all duration-300 ${isSidebarCollapsed ? 'md:pl-20' : 'md:pl-64'}`}>
                            <Header 
                                currentPage={currentPage} 
                                setIsSidebarOpen={setIsSidebarOpen} 
                                saveStatus={saveStatus}
                                handleSave={handleSave}
                            />
                            <main className="p-4 sm:p-6 lg:p-8">
                                {currentPage === 'dashboard' && <Dashboard navigateTo={navigateTo} data={appData} />}
                                {currentPage === 'group' && <GroupManagement data={appData} setData={setAppData} />}
                                {currentPage === 'visits' && <Visits data={appData} setData={setAppData} />}
                                {currentPage === 'messages' && <Messages data={appData.messages} setAppData={setAppData} />}
                                {currentPage === 'reminders' && <Reminders data={appData.reminders} setAppData={setAppData} />}
                                {currentPage === 'links' && <UsefulLinks data={appData.links} setAppData={setAppData} />}
                                {currentPage === 'toolbox' && <Toolbox data={appData.toolbox} setAppData={setAppData} />}
                                {currentPage === 'settings' && <SettingsPage data={appData} setData={setAppData} />}
                            </main>
                        </div>
                    </div>
                </>
            )
        }
        
        // --- COMPONENTI UI GENERICI ---
        const Sidebar = ({ currentPage, navigateTo, isSidebarOpen, setIsSidebarOpen, isCollapsed, onToggleCollapse }) => {
            const navItems = [
                { id: 'dashboard', label: 'Dashboard', icon: 'Home' },
                { id: 'group', label: 'Gruppo di Servizio', icon: 'Users' },
                { id: 'visits', label: 'Visite Pastorali', icon: 'CalendarCheck' },
                { id: 'messages', label: 'Comunicazioni', icon: 'MessageSquareText' },
                { id: 'reminders', label: 'Promemoria', icon: 'ListTodo' },
                { id: 'toolbox', label: 'Cassetta Attrezzi', icon: 'Briefcase' },
                { id: 'links', label: 'Link Utili', icon: 'Link' },
                { id: 'settings', label: 'Impostazioni', icon: 'Settings' },
            ]
        
            return (
                <>
                    <div
                        className={`fixed inset-0 bg-black bg-opacity-50 z-40 md:hidden ${isSidebarOpen ? 'block' : 'hidden'}`}
                        onClick={() => setIsSidebarOpen(false)}
                    ></div>
                    <aside className={`fixed top-0 left-0 h-full bg-[var(--brand-color)] text-white transform transition-all duration-300 z-50 flex flex-col ${isCollapsed ? 'w-20' : 'w-64'} ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:translate-x-0`}>
                        <div className={`p-4 flex items-center justify-between`}>
                            <h1 className={`text-2xl font-bold whitespace-nowrap overflow-hidden transition-opacity font-nunito ${isCollapsed ? 'opacity-0 w-0' : 'opacity-100'}`}>JW Shepherd</h1>
                            <button onClick={() => setIsSidebarOpen(false)} className={`md:hidden ${!isCollapsed ? 'block' : 'hidden'}`}>
                                <Icon name="X" />
                            </button>
                            <button onClick={() => onToggleCollapse(prev => !prev)} className="hidden md:block p-1 rounded-md hover:bg-[var(--brand-color-dark)]">
                                <Icon name="Menu" />
                            </button>
                        </div>
                        <nav className="flex-1 px-2">
                            {navItems.map(item => (
                                <NavItem
                                    key={item.id}
                                    isCollapsed={isCollapsed}
                                    {...item}
                                    isActive={currentPage === item.id}
                                    onClick={() => navigateTo(item.id)}
                                />
                            ))}
                        </nav>
                    </aside>
                </>
            )
        }
        
        const NavItem = ({ label, icon, isActive, onClick, isCollapsed }) => (
            <a
                href="#"
                onClick={(e) => { e.preventDefault(); onClick(); }}
                className={`flex items-center p-3 my-1 rounded-lg transition-colors duration-200 ${isCollapsed ? 'justify-center' : ''} ${isActive ? 'bg-[var(--brand-color-darker)]' : 'hover:bg-[var(--brand-color-dark)]'}`}
                title={label}
            >
                <Icon name={icon} size={20} />
                <span className={`whitespace-nowrap transition-all duration-200 ${isCollapsed ? 'w-0 ml-0 opacity-0' : 'w-auto ml-3 opacity-100'}`}>{label}</span>
            </a>
        )
        
        const Header = ({ currentPage, setIsSidebarOpen, saveStatus, handleSave }) => {
            const titles = {
                dashboard: 'Dashboard', group: 'Gruppo di Servizio', visits: 'Visite Pastorali', messages: 'Comunicazioni Gruppo', reminders: 'Promemoria', toolbox: 'Cassetta degli Attrezzi', links: 'Link Utili', settings: 'Impostazioni'
            }
        
            return (
                <header className="bg-white shadow-sm p-4 flex items-center justify-between sticky top-0 z-30">
                    <button onClick={() => setIsSidebarOpen(true)} className="text-gray-600 md:hidden">
                        <Icon name="Menu" size={24} />
                    </button>
                    <h2 className="text-xl sm:text-2xl font-semibold text-gray-800">{titles[currentPage]}</h2>
                     <div className="flex items-center space-x-4">
                        <span className="text-sm text-gray-500 italic">{saveStatus}</span>
                        <button onClick={handleSave} className="p-2 bg-[var(--brand-color)] text-white rounded-full shadow hover:bg-[var(--brand-color-dark)]" title="Salva Modifiche">
                            <Icon name="Save" size={20}/>
                        </button>
                    </div>
                </header>
            )
        }
        
        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null
        
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-lg max-h-full overflow-y-auto">
                        <div className="flex justify-between items-center p-4 border-b">
                            <h3 className="text-xl font-semibold text-gray-800">{title}</h3>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-800">
                                <Icon name="X" size={24} />
                            </button>
                        </div>
                        <div className="p-6">
                            {children}
                        </div>
                    </div>
                </div>
            )
        }

        const CrudForm = ({ fields, initialData, onSubmit, onCancel }) => {
            const [formData, setFormData] = useState(initialData);
        
            useEffect(() => {
                setFormData(initialData);
            }, [initialData]);
            
            const handleChange = (e) => {
                const { name, value, type, checked } = e.target;
                setFormData(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : value }));
            };
        
            const handleRichTextChange = (name, value) => {
                setFormData(prev => ({ ...prev, [name]: value }));
            }
        
            const handleSubmit = (e) => {
                e.preventDefault();
                onSubmit(formData);
            };
        
            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    {fields.map(field => (
                        <div key={field.name}>
                            <label htmlFor={field.name} className="block text-sm font-medium text-gray-700 mb-1">{field.label}</label>
                            {field.type === 'richtext' ? (
                               <RichTextEditor
                                    value={formData[field.name] || ''}
                                    onChange={(value) => handleRichTextChange(field.name, value)}
                               />
                            ) :field.type === 'textarea' ? (
                                <textarea id={field.name} name={field.name} value={formData[field.name] || ''} onChange={handleChange} rows="4" className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder={field.placeholder}/>
                            ) : field.type === 'select' ? (
                                <select id={field.name} name={field.name} value={formData[field.name] || ''} onChange={handleChange} className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required={field.required}>
                                     <option value="">{field.placeholder || 'Seleziona...'}</option>
                                     {field.options.map(opt => <option key={opt.value || opt} value={opt.value || opt}>{opt.label || opt}</option>)}
                                </select>
                            ) : field.type === 'checkbox' ? (
                                <div className="flex items-center pt-2">
                                     <input id={field.name} name={field.name} type="checkbox" checked={!!formData[field.name]} onChange={handleChange} className="h-4 w-4 text-[var(--brand-color)] border-gray-300 rounded focus:ring-[var(--brand-color-dark)]"/>
                                     <label htmlFor={field.name} className="ml-2 block text-sm text-gray-900">{field.label}</label>
                                </div>
                            ) : (
                                <input type={field.type} id={field.name} name={field.name} value={formData[field.name] || ''} onChange={handleChange} className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder={field.placeholder} required={field.required}/>
                            )}
                        </div>
                    ))}
                    <div className="flex justify-end space-x-3 pt-4">
                        <button type="button" onClick={onCancel} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Annulla</button>
                        <button type="submit" className="px-4 py-2 bg-[var(--brand-color)] text-white rounded-md hover:bg-[var(--brand-color-dark)]">Salva</button>
                    </div>
                </form>
            );
        };
        
        // --- PAGINE SPECIFICHE ---
        const Dashboard = ({ navigateTo, data }) => {
            const { families, visits, reminders } = data;
            const upcomingVisits = visits.filter(v => !v.completed).sort((a,b) => new Date(a.date) - new Date(b.date)).slice(0, 3);
            const activeReminders = reminders.filter(r => !r.completed).sort((a,b) => new Date(a.date) - new Date(b.date)).slice(0, 3);
            const totalFamilies = families.length;
            const completedVisits = visits.filter(v => v.completed).length;

            const StatCard = ({ icon, label, value, color }) => (
                <div className="bg-white p-4 rounded-lg shadow flex items-center">
                    <div className={`p-3 rounded-full mr-4 ${color}`}>
                        <Icon name={icon} size={24} />
                    </div>
                    <div>
                        <p className="text-3xl font-bold text-gray-800">{value}</p>
                        <p className="text-gray-500">{label}</p>
                    </div>
                </div>
            );
            
            const isImminent = (dateString) => {
                const now = new Date();
                const itemDate = new Date(dateString);
                const tenMinutesFromNow = new Date(now.getTime() + 10 * 60 * 1000);
                return itemDate > now && itemDate <= tenMinutesFromNow;
            };

            return (
                <div className="space-y-6">
                    <div>
                        <h2 className="text-2xl font-bold text-gray-800">Benvenuto,</h2>
                        <p className="text-gray-600">Oggi è {new Date().toLocaleDateString('it-IT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}.</p>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <StatCard icon="Users" label="Famiglie nel gruppo" value={totalFamilies} color="bg-blue-100 text-blue-600" />
                        <StatCard icon="CheckCircle" label="Visite completate" value={completedVisits} color="bg-green-100 text-green-600" />
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div className="bg-white p-6 rounded-lg shadow">
                            <h3 className="text-lg font-semibold text-gray-800 mb-4 flex items-center"><Icon name="CalendarCheck" size={22} /><span className="ml-2">Prossime Visite Pastorali</span></h3>
                            {upcomingVisits.length > 0 ? (
                                <ul className="space-y-3">{upcomingVisits.map(visit => (
                                    <li key={visit.id} className={`flex items-center justify-between p-3 bg-gray-50 rounded-md hover:bg-gray-100 transition-colors ${isImminent(visit.date) ? 'glowing-activity' : ''}`}>
                                        <div>
                                            <p className="font-semibold">{visit.familyName}</p>
                                            <p className="text-sm text-gray-600">{new Date(visit.date).toLocaleString('it-IT', { day: '2-digit', month: 'long', hour: '2-digit', minute: '2-digit' })}</p>
                                        </div>
                                        <button onClick={() => navigateTo('visits')} className="text-sm text-[var(--brand-text-color)] hover:text-[var(--brand-text-hover)] font-semibold">Vedi</button>
                                    </li>
                                ))}</ul>
                            ) : <p className="text-gray-500">Nessuna visita programmata.</p>}
                        </div>
                        <div className="bg-white p-6 rounded-lg shadow">
                             <h3 className="text-lg font-semibold text-gray-800 mb-4 flex items-center"><Icon name="ListTodo" size={22} /><span className="ml-2">Promemoria Attivi</span></h3>
                            {activeReminders.length > 0 ? (
                                <ul className="space-y-3">{activeReminders.map(reminder => (
                                    <li key={reminder.id} className={`flex items-center justify-between p-3 bg-gray-50 rounded-md hover:bg-gray-100 transition-colors ${isImminent(reminder.date) ? 'glowing-activity' : ''}`}>
                                        <p className="font-semibold">{reminder.text}</p>
                                        <button onClick={() => navigateTo('reminders')} className="text-sm text-[var(--brand-text-color)] hover:text-[var(--brand-text-hover)] font-semibold">Vedi</button>
                                    </li>
                                ))}</ul>
                            ) : <p className="text-gray-500">Nessun promemoria attivo.</p>}
                        </div>
                    </div>
                </div>
            );
        };
        
        const GroupManagement = ({ data, setData }) => {
            const { families, group_members: members } = data;
            
            const [familyModalOpen, setFamilyModalOpen] = useState(false);
            const [memberModalOpen, setMemberModalOpen] = useState(false);
            const [currentFamily, setCurrentFamily] = useState(null);
            const [currentMember, setCurrentMember] = useState(null);
            const [expandedFamilies, setExpandedFamilies] = useState({});

            const toggleFamilyExpansion = (familyId) => {
                setExpandedFamilies(prev => ({ ...prev, [familyId]: !prev[familyId] }));
            };

            const handleSaveFamily = (formData) => {
                if (currentFamily) {
                    setData(prev => ({ ...prev, families: prev.families.map(f => f.id === currentFamily.id ? { ...f, ...formData } : f) }));
                } else {
                    setData(prev => ({...prev, families: [...prev.families, { ...formData, id: `f${Date.now()}` }]}));
                }
                setFamilyModalOpen(false);
                setCurrentFamily(null);
            };

            const handleDeleteFamily = (familyId) => {
                if(confirm("Sei sicuro di voler eliminare questa famiglia e i suoi membri?")){
                    setData(prev => ({ 
                        ...prev, 
                        families: prev.families.filter(f => f.id !== familyId),
                        group_members: prev.group_members.filter(m => m.familyId !== familyId)
                    }));
                }
            };

            const handleSaveMember = (formData) => {
                const dataToSave = { ...formData, tags: (formData.tags || '').split(',').map(t => t.trim()).filter(Boolean) };
                if (currentMember) {
                    setData(prev => ({ ...prev, group_members: prev.group_members.map(m => m.id === currentMember.id ? { ...m, ...dataToSave } : m)}));
                } else {
                    setData(prev => ({ ...prev, group_members: [...prev.group_members, { ...dataToSave, familyId: currentFamily.id, id: `m${Date.now()}` }]}));
                }
                setMemberModalOpen(false);
                setCurrentMember(null);
            };

            const sortedFamilies = [...families].sort((a,b) => a.name.localeCompare(b.name));

            return (
                <div>
                    <div className="flex justify-end mb-6">
                         <button onClick={() => { setCurrentFamily(null); setFamilyModalOpen(true); }} className="flex items-center px-4 py-2 bg-[var(--brand-color)] text-white rounded-lg shadow hover:bg-[var(--brand-color-dark)]"><Icon name="Plus" size={20} /><span className="ml-2">Aggiungi Famiglia</span></button>
                    </div>
        
                    <Modal isOpen={familyModalOpen} onClose={() => setFamilyModalOpen(false)} title={currentFamily ? 'Modifica Famiglia' : 'Aggiungi Famiglia'}>
                        <CrudForm fields={[ {name: 'name', label: 'Nome Famiglia', type: 'text', required: true}, {name: 'address', label: 'Indirizzo', type: 'text'}, {name: 'notes', label: 'Note', type: 'richtext'} ]} initialData={currentFamily || { name: '', address: '', notes: '' }} onSubmit={handleSaveFamily} onCancel={() => setFamilyModalOpen(false)} />
                    </Modal>
                    <Modal isOpen={memberModalOpen} onClose={() => setMemberModalOpen(false)} title={currentMember ? 'Modifica Membro' : `Aggiungi Membro a Fam. ${currentFamily?.name}`}>
                         <CrudForm fields={[ {name: 'fullName', label: 'Nome e Cognome', type: 'text', required: true}, {name: 'role', label: 'Ruolo', type: 'text'}, {name: 'phone', label: 'Telefono', type: 'tel'}, {name: 'email', label: 'Email', type: 'email'}, {name: 'tags', label: 'Tag (separati da virgola)', type: 'text'} ]} initialData={currentMember ? { ...currentMember, tags: (currentMember.tags || []).join(', ') } : { fullName: '', role: '', phone: '', email: '', tags: '' }} onSubmit={handleSaveMember} onCancel={() => setMemberModalOpen(false)} />
                    </Modal>
        
                    <div className="space-y-6">
                        {sortedFamilies.length > 0 ? sortedFamilies.map(family => {
                            const familyMembers = members.filter(m => m.familyId === family.id).sort((a,b) => a.fullName.localeCompare(b.name));
                            return (<div key={family.id} className="bg-white p-4 sm:p-6 rounded-lg shadow">
                                <div className="flex justify-between items-start mb-4">
                                    <div>
                                        <h3 className="text-xl font-bold text-[var(--brand-text-color)]">{family.name}</h3>
                                        <p className="text-gray-600">{family.address}</p>
                                        <div className="note-content mt-1 text-sm text-gray-700 bg-yellow-100 p-2 rounded" dangerouslySetInnerHTML={{ __html: family.notes }}></div>
                                    </div>
                                    <div className="flex items-center space-x-2">
                                        <button onClick={() => { setCurrentFamily(family); setFamilyModalOpen(true); }} className="p-2 text-[var(--brand-text-color)] hover:text-[var(--brand-text-hover)]"><Icon name="Edit"/></button>
                                        <button onClick={() => handleDeleteFamily(family.id)} className="p-2 text-red-600 hover:text-red-800"><Icon name="Trash2"/></button>
                                    </div>
                                </div>
                                <div className="border-t pt-4">
                                    <div className="flex justify-between items-center cursor-pointer" onClick={() => toggleFamilyExpansion(family.id)}>
                                        <h4 className="font-semibold text-gray-700">Membri ({familyMembers.length})</h4>
                                        <button className="p-1 rounded-full hover:bg-gray-200">{expandedFamilies[family.id] ? <Icon name="ChevronUp"/> : <Icon name="ChevronDown"/>}</button>
                                    </div>
                                    <div className={`transition-all duration-300 ease-in-out overflow-hidden ${expandedFamilies[family.id] ? 'max-h-full mt-2' : 'max-h-0'}`}>
                                        <div className="space-y-2 pt-2">{familyMembers.map(member => (<div key={member.id} className="flex justify-between items-center bg-gray-50 p-3 rounded-md"><div><p className="font-semibold">{member.fullName} <span className="font-normal text-gray-500 text-sm">({member.role})</span></p><div className="flex flex-col sm:flex-row sm:items-center sm:gap-4 mt-2">{member.phone && <a href={`tel:${member.phone}`} onClick={(e) => e.stopPropagation()} className="flex items-center gap-2 text-sm text-gray-600 hover:text-[var(--brand-text-color)]"><Icon name="Phone" size={14}/><span>{member.phone}</span></a>}{member.email && <a href={`mailto:${member.email}`} onClick={(e) => e.stopPropagation()} className="flex items-center gap-2 text-sm text-gray-600 hover:text-[var(--brand-text-color)]"><Icon name="Mail" size={14}/><span>{member.email}</span></a>}</div><div className="mt-2 flex flex-wrap gap-2">{ (member.tags || []).map(tag => <span key={tag} className="px-2 py-1 bg-[var(--brand-color-light)] text-[var(--brand-color-dark)] text-xs font-semibold rounded-full">{tag}</span>) }</div></div><div className="flex space-x-2"><button onClick={() => { setCurrentFamily(family); setCurrentMember(member); setMemberModalOpen(true); }} className="p-1 text-[var(--brand-text-color)] hover:text-[var(--brand-text-hover)]"><Icon name="Edit" size={16}/></button><button onClick={() => setData(prev => ({...prev, group_members: prev.group_members.filter(m => m.id !== member.id)}))} className="p-1 text-red-600 hover:text-red-800"><Icon name="Trash2" size={16}/></button></div></div>))}</div>
                                    </div>
                                </div>
                                <div className="mt-4"><button onClick={() => { setCurrentFamily(family); setCurrentMember(null); setMemberModalOpen(true); }} className="text-sm flex items-center px-3 py-1 bg-[var(--brand-color-light)] text-[var(--brand-text-color)] rounded-md hover:bg-[var(--brand-color-lighter)]"><Icon name="Plus" size={16} /><span className="ml-1">Aggiungi membro</span></button></div>
                            </div>)
                        }) : <p className="text-center text-gray-500 py-8">Nessuna famiglia presente. Inizia aggiungendone una!</p>}
                    </div>
                </div>);
        };
        
        const Visits = ({ data, setData }) => {
            const { visits, families } = data;
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [currentItem, setCurrentItem] = useState(null);
            const [archiveVisible, setArchiveVisible] = useState(false);
            const initialState = { familyId: '', familyName: '', date: '', category: '', scriptures: '', topic: '', notes: '', completed: false, recurring: 'nessuna', endDate: '' };

            const handleSave = (formData) => {
                const selectedFamily = families.find(f => f.id === formData.familyId);
                const dataToSave = { ...formData, familyName: selectedFamily ? selectedFamily.name : 'Famiglia Sconosciuta' };
                
                if (currentItem) {
                    setData(prev => ({...prev, visits: prev.visits.map(v => v.id === currentItem.id ? { ...v, ...dataToSave } : v)}));
                } else { 
                    setData(prev => ({ ...prev, visits: [...prev.visits, {...dataToSave, id: `v${Date.now()}`}] }));
                }
                setIsModalOpen(false);
                setCurrentItem(null);
            };

            const handleDelete = (id) => {
                if (confirm("Sei sicuro di voler eliminare questa visita?")) {
                  setData(prev => ({...prev, visits: prev.visits.filter(v => v.id !== id)}));
                }
            };
            
            const handleToggleComplete = (visitToToggle) => {
                 let updatedVisits = data.visits.map(v => 
                     v.id === visitToToggle.id ? { ...v, completed: !v.completed } : v
                 );
 
                 if (!visitToToggle.completed && visitToToggle.recurring && visitToToggle.recurring !== 'nessuna') {
                     const nextDate = new Date(visitToToggle.date);
                     switch (visitToToggle.recurring) {
                        case 'settimanale': nextDate.setDate(nextDate.getDate() + 7); break;
                        case 'mensile': nextDate.setMonth(nextDate.getMonth() + 1); break;
                        case 'bimestrale': nextDate.setMonth(nextDate.getMonth() + 2); break;
                        case 'trimestrale': nextDate.setMonth(nextDate.getMonth() + 3); break;
                        case 'semestrale': nextDate.setMonth(nextDate.getMonth() + 6); break;
                        case 'annuale': nextDate.setFullYear(nextDate.getFullYear() + 1); break;
                     }
                     const endDate = visitToToggle.endDate ? new Date(visitToToggle.endDate) : null;
                     if (!endDate || nextDate <= endDate) {
                         const newVisit = {
                             ...visitToToggle,
                             id: `v${Date.now()}`,
                             date: nextDate.toISOString(),
                             completed: false,
                             topic: '',
                             scriptures: '',
                             notes: `<blockquote><i>Dalla visita del ${new Date(visitToToggle.date).toLocaleDateString('it-IT')}:<br><b>Argomento:</b> ${visitToToggle.topic || 'N/D'}<br><b>Scritture:</b> ${visitToToggle.scriptures || 'N/D'}<br><b>Note:</b> ${visitToToggle.notes.replace(/<[^>]*>?/gm, '') || 'N/D'}</i></blockquote><br>`,
                         };
                         updatedVisits.push(newVisit);
                     }
                 }
                 setData(prev => ({ ...prev, visits: updatedVisits }));
             };
            
            const pendingVisits = visits.filter(v => !v.completed).sort((a, b) => new Date(a.date) - new Date(b.date));
            const completedVisits = visits.filter(v => v.completed).sort((a, b) => new Date(b.date) - new Date(a.date));

            return (<div>
                <div className="flex justify-end mb-6">
                         <button onClick={() => { setCurrentItem(null); setIsModalOpen(true); }} className="flex items-center px-4 py-2 bg-[var(--brand-color)] text-white rounded-lg shadow hover:bg-[var(--brand-color-dark)]"><Icon name="Plus" size={20} /><span className="ml-2">Programma Visita</span></button>
                </div>
                    <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title={currentItem ? "Modifica Visita" : "Programma Visita"}>
                         <VisitForm initialData={currentItem || initialState} onSubmit={handleSave} onCancel={() => setIsModalOpen(false)} families={families} isEditing={!!currentItem}/>
                    </Modal>
                    <div className="bg-white p-4 sm:p-6 rounded-lg shadow">{pendingVisits.length > 0 ? (<div className="space-y-4">{pendingVisits.map(visit => (<div key={visit.id} className={`p-4 border rounded-lg shadow-sm bg-orange-50`}><div className="flex justify-between items-start"><div className="flex-1"><div className="flex items-center gap-3"><button onClick={() => handleToggleComplete(visit)} className="flex-shrink-0"><Icon name='Circle' size={22} /></button><div><div className="flex items-center gap-2"><h4 className="font-bold text-lg text-[var(--brand-text-color)]">{visit.familyName}</h4>{visit.recurring && visit.recurring !== 'nessuna' && <Icon name="Repeat" size={16}/>}{visit.category && <span className="px-2 py-0.5 bg-purple-200 text-purple-800 text-xs font-semibold rounded-full">{visit.category}</span>}</div><p className="font-semibold text-gray-700">{new Date(visit.date).toLocaleString('it-IT', { day: '2-digit', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</p></div></div><p className="mt-2 text-gray-600"><strong>Argomento:</strong> {visit.topic}</p>{visit.scriptures && <p className="mt-1 text-gray-600"><strong>Scritture:</strong> {visit.scriptures}</p>}<div className="note-content mt-2 text-sm text-gray-700 bg-gray-100 p-2 rounded" dangerouslySetInnerHTML={{ __html: visit.notes }}></div></div><div className="flex items-center space-x-2"><button onClick={() => { setCurrentItem(visit); setIsModalOpen(true); }} className="p-2 text-[var(--brand-text-color)] hover:text-[var(--brand-text-hover)]"><Icon name="Edit"/></button><button onClick={() => handleDelete(visit.id)} className="p-2 text-red-600 hover:text-red-800"><Icon name="Trash2"/></button></div></div></div>))}</div>) : <p className="text-center text-gray-500 py-8">Nessuna visita in programma.</p>}</div>
                
                <div className="mt-8">
                    <button onClick={() => setArchiveVisible(!archiveVisible)} className="font-semibold text-gray-600 flex items-center mb-4">
                        <Icon name={archiveVisible ? 'ChevronDown' : 'ChevronUp'} /> <span className="ml-2">Archivio Visite Eseguite ({completedVisits.length})</span>
                    </button>
                    {archiveVisible && (
                        <div className="bg-white p-4 sm:p-6 rounded-lg shadow space-y-4">
                            {completedVisits.length > 0 ? completedVisits.map(visit => (
                                <div key={visit.id} className="p-4 border rounded-lg bg-green-50 opacity-80 flex justify-between items-center">
                                    <div>
                                        <p className="font-semibold">{visit.familyName} - {new Date(visit.date).toLocaleDateString('it-IT')}</p>
                                        <p className="text-sm text-gray-600">{visit.topic}</p>
                                    </div>
                                    <div className="flex items-center space-x-2">
                                        <button onClick={() => handleToggleComplete(visit)} className="p-2 text-blue-600 hover:text-blue-800" title="Riattiva"><Icon name="RotateCcw"/></button>
                                        <button onClick={() => {setCurrentItem(visit); setIsModalOpen(true);}} className="p-2 text-[var(--brand-text-color)] hover:text-[var(--brand-text-hover)]" title="Modifica"><Icon name="Edit"/></button>
                                        <button onClick={() => handleDelete(visit.id)} className="p-2 text-red-600 hover:text-red-800" title="Elimina"><Icon name="Trash2"/></button>
                                    </div>
                                </div>
                            )) : <p className="text-center text-gray-500 py-4">Nessuna visita archiviata.</p>}
                        </div>
                    )}
                </div>
            </div>);
        };
        
        const VisitForm = ({ initialData, onSubmit, onCancel, families, isEditing }) => {
            const [formData, setFormData] = useState(initialData);
            
            const handleChange = (e) => {
                const { name, value, type, checked } = e.target;
                setFormData(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : value }));
            };
            const handleRichTextChange = (name, value) => {
                setFormData(prev => ({ ...prev, [name]: value }));
            };
            const handleSubmit = (e) => {
                e.preventDefault();
                onSubmit(formData);
            };

            const recurrenceOptions = [
                { value: 'nessuna', label: 'Nessuna' },
                { value: 'settimanale', label: 'Ogni settimana' },
                { value: 'mensile', label: 'Ogni mese' },
                { value: 'bimestrale', label: 'Ogni 2 mesi' },
                { value: 'trimestrale', label: 'Ogni 3 mesi' },
                { value: 'semestrale', label: 'Ogni 6 mesi' },
                { value: 'annuale', label: 'Ogni anno' }
            ];
            
            const baseFields = [
                { name: 'familyId', label: 'Famiglia', type: 'select', required: true, options: [{value: '', label: 'Seleziona una famiglia...'}, ...families.map(f => ({ value: f.id, label: f.name }))] },
                { name: 'date', label: 'Data e Ora Inizio', type: 'datetime-local', required: true },
                { name: 'category', label: 'Categoria', type: 'select', options: ['Incoraggiamento', 'Visita malato', 'Ospitalità', 'Altro'], placeholder: 'Nessuna categoria' },
                { name: 'topic', label: 'Argomento trattato', type: 'text' },
                { name: 'scriptures', label: 'Scritture considerate', type: 'textarea' },
                { name: 'notes', label: 'Note', type: 'richtext' }
            ];

            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                     {baseFields.map(field => (
                        <div key={field.name}>
                            <label htmlFor={field.name} className="block text-sm font-medium text-gray-700 mb-1">{field.label}</label>
                            {field.type === 'richtext' ? (
                               <RichTextEditor
                                    value={formData[field.name] || ''}
                                    onChange={(value) => handleRichTextChange(field.name, value)}
                               />
                            ) :field.type === 'textarea' ? (
                                <textarea id={field.name} name={field.name} value={formData[field.name] || ''} onChange={handleChange} rows="4" className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder={field.placeholder}/>
                            ) : field.type === 'select' ? (
                                <select id={field.name} name={field.name} value={formData[field.name] || ''} onChange={handleChange} className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required={field.required} disabled={isEditing && field.name === 'familyId'}>
                                     <option value="">{field.placeholder || 'Seleziona...'}</option>
                                     {field.options.map(opt => <option key={opt.value || opt} value={opt.value || opt}>{opt.label || opt}</option>)}
                                </select>
                            ) : (
                                <input type={field.type} id={field.name} name={field.name} value={formData[field.name] || ''} onChange={handleChange} className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder={field.placeholder} required={field.required}/>
                            )}
                        </div>
                    ))}

                    {!isEditing && (
                        <div className="p-4 bg-gray-50 rounded-lg">
                            <h4 className="font-semibold mb-2">Imposta Periodicità</h4>
                            <div>
                                <label htmlFor="recurring" className="block text-sm font-medium text-gray-700 mb-1">Periodicità</label>
                                <select id="recurring" name="recurring" value={formData.recurring} onChange={handleChange} className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" disabled={isEditing}>
                                    {recurrenceOptions.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
                                </select>
                            </div>
                            {formData.recurring !== 'nessuna' && (
                                <div className="mt-4">
                                    <label htmlFor="endDate" className="block text-sm font-medium text-gray-700 mb-1">Data di fine (opzionale)</label>
                                    <input type="date" id="endDate" name="endDate" value={formData.endDate || ''} onChange={handleChange} className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" disabled={isEditing} />
                                </div>
                            )}
                        </div>
                    )}
                    
                    <div className="flex justify-end space-x-3 pt-4">
                        <button type="button" onClick={onCancel} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Annulla</button>
                        <button type="submit" className="px-4 py-2 bg-[var(--brand-color)] text-white rounded-md hover:bg-[var(--brand-color-dark)]">Salva</button>
                    </div>
                </form>
            );
        };
        
        const PageWrapper = ({ title, itemType, data, setData, children }) => {
            return (
                <div>
                    <div className="flex justify-end mb-6">
                        {children}
                    </div>
                    <div className="bg-white p-4 sm:p-6 rounded-lg shadow">
                         {data.length > 0 ? (
                            <div className="space-y-4">{data}</div>
                        ) : <p className="text-center text-gray-500 py-8">Nessun elemento presente. Inizia aggiungendone uno!</p>}
                    </div>
                </div>
            )
        };
        
        const Messages = ({ data, setAppData }) => {
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [currentItem, setCurrentItem] = useState(null);
            const initialState = { type: '', text: '' };

            const handleSave = (formData) => {
                if (currentItem) {
                    setAppData(prev => ({ ...prev, messages: prev.messages.map(item => item.id === currentItem.id ? { ...item, ...formData } : item)}));
                } else {
                    setAppData(prev => ({...prev, messages: [...prev.messages, { ...formData, id: `c${Date.now()}` }]}));
                }
                setIsModalOpen(false);
                setCurrentItem(null);
            };

            const handleDelete = (id) => { if (confirm(`Sei sicuro di voler eliminare questo messaggio?`)) { setAppData(prev => ({...prev, messages: prev.messages.filter(item => item.id !== id)}))} };
            
            const copyToClipboard = (text) => {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = text;
                const plainText = tempDiv.textContent || tempDiv.innerText || "";
                navigator.clipboard.writeText(plainText).then(() => alert('Messaggio copiato negli appunti!'), () => alert('Errore nella copia.'));
            };

            return (
                <>
                    <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title={currentItem ? `Modifica Messaggio` : `Aggiungi Messaggio`}>
                        <CrudForm fields={[ { name: 'type', label: 'Tipo Messaggio', type: 'text', placeholder: 'Es. Promemoria adunanza', required: true }, { name: 'text', label: 'Testo', type: 'richtext' } ]} initialData={currentItem || initialState} onSubmit={handleSave} onCancel={() => setIsModalOpen(false)} />
                    </Modal>
                    <PageWrapper data={data.map(item => (
                        <div key={item.id} className="p-4 border rounded-lg shadow-sm bg-gray-50">
                            <div className="flex justify-between items-start">
                                <div className="flex-1 pr-4">
                                    <h4 className="font-bold text-lg text-[var(--brand-text-color)]">{item.type}</h4>
                                    <div className="note-content mt-2 text-gray-700" dangerouslySetInnerHTML={{ __html: item.text }}></div>
                                </div>
                                <div className="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-1">
                                    <button onClick={() => copyToClipboard(item.text)} className="p-2 text-blue-600 hover:text-blue-800"><Icon name="Copy"/></button>
                                    <button onClick={() => { setCurrentItem(item); setIsModalOpen(true); }} className="p-2 text-[var(--brand-text-color)] hover:text-[var(--brand-text-hover)]"><Icon name="Edit"/></button>
                                    <button onClick={() => handleDelete(item.id)} className="p-2 text-red-600 hover:text-red-800"><Icon name="Trash2"/></button>
                                </div>
                            </div>
                        </div>
                    ))}>
                        <button onClick={() => { setCurrentItem(null); setIsModalOpen(true); }} className="flex items-center px-4 py-2 bg-[var(--brand-color)] text-white rounded-lg shadow hover:bg-[var(--brand-color-dark)]">
                            <Icon name="Plus" size={20} /><span className="ml-2">Aggiungi Messaggio</span>
                        </button>
                    </PageWrapper>
                </>
            );
        };

        const Reminders = ({ data, setAppData }) => {
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [currentItem, setCurrentItem] = useState(null);
            const [archiveVisible, setArchiveVisible] = useState(false);

            const priorities = { Bassa: 'bg-green-200 text-green-800', Media: 'bg-yellow-200 text-yellow-800', Alta: 'bg-red-200 text-red-800' };
            const initialState = { date: '', text: '', priority: 'Media', completed: false };

            const handleSave = (formData) => {
                if (currentItem) {
                    setAppData(prev => ({...prev, reminders: prev.reminders.map(item => item.id === currentItem.id ? { ...item, ...formData } : item)}));
                } else {
                    setAppData(prev => ({...prev, reminders: [...prev.reminders, { ...formData, id: `r${Date.now()}` }]}));
                }
                setIsModalOpen(false);
                setCurrentItem(null);
            };

            const handleDelete = (id) => { if (confirm(`Sei sicuro di voler eliminare questo promemoria?`)) { setAppData(prev => ({...prev, reminders: prev.reminders.filter(item => item.id !== id)}))} };
            const handleToggleComplete = (itemToToggle) => { setAppData(prev => ({...prev, reminders: prev.reminders.map(r => r.id === itemToToggle.id ? { ...r, completed: !r.completed } : r)})) };
            
            const pendingReminders = data.filter(r => !r.completed).sort((a, b) => new Date(a.date) - new Date(b.date));
            const completedReminders = data.filter(r => r.completed).sort((a, b) => new Date(b.date) - new Date(a.date));

            return (
                <>
                    <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title={currentItem ? `Modifica Promemoria` : `Aggiungi Promemoria`}>
                        <CrudForm fields={[ { name: 'date', label: 'Data e Ora', type: 'datetime-local', required: true }, { name: 'text', label: 'Promemoria', type: 'text', placeholder: 'Cosa bisogna ricordare?', required: true }, { name: 'priority', label: 'Priorità', type: 'select', options: ['Bassa', 'Media', 'Alta'] } ]} initialData={currentItem || initialState} onSubmit={handleSave} onCancel={() => setIsModalOpen(false)} />
                    </Modal>
                    <PageWrapper data={pendingReminders.map(item => (
                        <div key={item.id} className={`p-4 border rounded-lg shadow-sm flex items-center justify-between`}>
                            <div className="flex items-center gap-4 flex-1">
                                <button onClick={() => handleToggleComplete(item)}><Icon name='Circle' size={22} /></button>
                                <div>
                                    <p className="font-semibold">{item.text}</p>
                                    <div className="flex items-center gap-2 mt-1">
                                        <p className="text-sm text-gray-500">{new Date(item.date).toLocaleString('it-IT', { day: '2-digit', month: 'long', hour: '2-digit', minute: '2-digit' })}</p>
                                        {item.priority && <span className={`px-2 py-0.5 text-xs font-semibold rounded-full ${priorities[item.priority]}`}>{item.priority}</span>}
                                    </div>
                                </div>
                            </div>
                            <div className="flex space-x-1">
                                <button onClick={() => { setCurrentItem(item); setIsModalOpen(true); }} className="p-2 text-[var(--brand-text-color)] hover:text-[var(--brand-text-hover)]"><Icon name="Edit"/></button>
                                <button onClick={() => handleDelete(item.id)} className="p-2 text-red-600 hover:text-red-800"><Icon name="Trash2"/></button>
                            </div>
                        </div>
                    ))}>
                         <button onClick={() => { setCurrentItem(null); setIsModalOpen(true); }} className="flex items-center px-4 py-2 bg-[var(--brand-color)] text-white rounded-lg shadow hover:bg-[var(--brand-color-dark)]">
                            <Icon name="Plus" size={20} /><span className="ml-2">Aggiungi Promemoria</span>
                        </button>
                    </PageWrapper>

                     <div className="mt-8">
                        <button onClick={() => setArchiveVisible(!archiveVisible)} className="font-semibold text-gray-600 flex items-center mb-4">
                            <Icon name={archiveVisible ? 'ChevronDown' : 'ChevronUp'} /> <span className="ml-2">Archivio Promemoria Eseguiti ({completedReminders.length})</span>
                        </button>
                        {archiveVisible && (
                            <div className="bg-white p-4 sm:p-6 rounded-lg shadow space-y-4">
                                {completedReminders.length > 0 ? completedReminders.map(item => (
                                    <div key={item.id} className="p-4 border rounded-lg bg-gray-100 opacity-70 flex justify-between items-center">
                                        <div>
                                            <p className="font-semibold line-through">{item.text}</p>
                                            <p className="text-sm text-gray-500">{new Date(item.date).toLocaleDateString('it-IT')}</p>
                                        </div>
                                         <div className="flex items-center space-x-2">
                                            <button onClick={() => handleToggleComplete(item)} className="p-2 text-blue-600 hover:text-blue-800" title="Riattiva"><Icon name="RotateCcw"/></button>
                                            <button onClick={() => handleDelete(item.id)} className="p-2 text-red-600 hover:text-red-800" title="Elimina"><Icon name="Trash2"/></button>
                                        </div>
                                    </div>
                                )) : <p className="text-center text-gray-500 py-4">Nessun promemoria archiviato.</p>}
                            </div>
                        )}
                    </div>
                </>
            );
        };
        
        const Toolbox = ({ data, setAppData }) => {
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [currentItem, setCurrentItem] = useState(null);
            const initialState = { title: '', url: '', description: '' };

            const handleSave = (formData) => {
                if (currentItem) { setAppData(prev => ({...prev, toolbox: prev.toolbox.map(item => item.id === currentItem.id ? { ...item, ...formData } : item)})); } 
                else { setAppData(prev => ({...prev, toolbox: [...prev.toolbox, { ...formData, id: `t${Date.now()}` }]})); }
                setIsModalOpen(false);
                setCurrentItem(null);
            };

            const handleDelete = (id) => { if (confirm(`Sei sicuro di voler eliminare questa risorsa?`)) { setAppData(prev => ({...prev, toolbox: prev.toolbox.filter(item => item.id !== id)})) } };
            
            return (
                <>
                    <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title={currentItem ? `Modifica Risorsa` : `Aggiungi Risorsa`}>
                        <CrudForm fields={[ { name: 'title', label: 'Titolo', type: 'text', placeholder: 'Es. Articolo sull\'incoraggiamento', required: true }, { name: 'url', label: 'URL', type: 'url', placeholder: 'https://www.jw.org/...', required: true }, { name: 'description', label: 'richtext' } ]} initialData={currentItem || initialState} onSubmit={handleSave} onCancel={() => setIsModalOpen(false)} />
                    </Modal>
                    <PageWrapper data={data.map(item => (
                        <div key={item.id} className="p-4 border rounded-lg shadow-sm bg-gray-50">
                            <div className="flex justify-between items-start">
                                <div className="flex-1 pr-4">
                                    <h4 className="font-bold text-lg text-[var(--brand-text-color)]">{item.title}</h4>
                                    <a href={item.url} target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:underline break-all">{item.url}</a>
                                    <div className="note-content mt-2 text-gray-600" dangerouslySetInnerHTML={{ __html: item.description }}></div>
                                </div>
                                <div className="flex space-x-1">
                                    <button onClick={() => { setCurrentItem(item); setIsModalOpen(true); }} className="p-2 text-[var(--brand-text-color)] hover:text-[var(--brand-text-hover)]"><Icon name="Edit"/></button>
                                    <button onClick={() => handleDelete(item.id)} className="p-2 text-red-600 hover:text-red-800"><Icon name="Trash2"/></button>
                                </div>
                            </div>
                        </div>
                    ))}>
                         <button onClick={() => { setCurrentItem(null); setIsModalOpen(true); }} className="flex items-center px-4 py-2 bg-[var(--brand-color)] text-white rounded-lg shadow hover:bg-[var(--brand-color-dark)]">
                            <Icon name="Plus" size={20} /><span className="ml-2">Aggiungi Risorsa</span>
                        </button>
                    </PageWrapper>
                </>
            );
        };

        const UsefulLinks = ({ data, setAppData }) => {
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [currentItem, setCurrentItem] = useState(null);
            const initialState = { name: '', url: '' };
            
            const handleSave = (formData) => {
                if (currentItem) { setAppData(prev => ({...prev, links: prev.links.map(item => item.id === currentItem.id ? { ...item, ...formData } : item)})); } 
                else { setAppData(prev => ({...prev, links: [...prev.links, { ...formData, id: `l${Date.now()}` }]})); }
                setIsModalOpen(false);
                setCurrentItem(null);
            };

            const handleDelete = (id) => { if (confirm(`Sei sicuro di voler eliminare questo link?`)) { setAppData(prev => ({...prev, links: prev.links.filter(item => item.id !== id)})) } };

            const Favicon = ({ url }) => {
                const [error, setError] = useState(false);
                let domain;
                try {
                    domain = new URL(url).hostname;
                } catch (e) {
                    return <Icon name="Link" size={24} />;
                }
                const faviconUrl = `https://www.google.com/s2/favicons?sz=32&domain_url=${domain}`;

                if (error) { return <Icon name="Link" size={24} className="text-gray-400 flex-shrink-0" />; }

                return <img src={faviconUrl} alt="favicon" className="w-6 h-6 mr-3 flex-shrink-0" onError={() => setError(true)} />;
            };
            
            return (
                 <>
                    <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title={currentItem ? `Modifica Link` : `Aggiungi Link`}>
                        <CrudForm fields={[ { name: 'name', label: 'Nome Sito', type: 'text', placeholder: 'jw.org', required: true }, { name: 'url', label: 'URL', type: 'url', placeholder: 'https://www.jw.org', required: true } ]} initialData={currentItem || initialState} onSubmit={handleSave} onCancel={() => setIsModalOpen(false)} />
                    </Modal>
                    <PageWrapper data={data.map(item => (
                         <div key={item.id} className="p-4 border rounded-lg shadow-sm bg-gray-50 flex justify-between items-center">
                            <div className="flex items-center flex-1">
                                <Favicon url={item.url} />
                                <div>
                                    <h4 className="font-bold text-lg text-[var(--brand-text-color)]">{item.name}</h4>
                                    <a href={item.url} target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:underline break-all">{item.url}</a>
                                </div>
                            </div>
                            <div className="flex space-x-1">
                                <button onClick={() => { setCurrentItem(item); setIsModalOpen(true); }} className="p-2 text-[var(--brand-text-color)] hover:text-[var(--brand-text-hover)]"><Icon name="Edit"/></button>
                                <button onClick={() => handleDelete(item.id)} className="p-2 text-red-600 hover:text-red-800"><Icon name="Trash2"/></button>
                            </div>
                        </div>
                    ))}>
                         <button onClick={() => { setCurrentItem(null); setIsModalOpen(true); }} className="flex items-center px-4 py-2 bg-[var(--brand-color)] text-white rounded-lg shadow hover:bg-[var(--brand-color-dark)]">
                            <Icon name="Plus" size={20} /><span className="ml-2">Aggiungi Link</span>
                        </button>
                    </PageWrapper>
                </>
            );
        };

        const SettingsPage = ({ data, setData }) => {
            const handleBackup = () => {
                try {
                    const jsonString = `data:text/json;charset=utf-8,${encodeURIComponent(JSON.stringify(data, null, 2))}`;
                    const link = document.createElement("a");
                    link.href = jsonString;
                    link.download = `jw-shepherd-backup-${new Date().toISOString().split('T')[0]}.json`;
                    link.click();
                    link.remove();
                    alert("Backup eseguito con successo!");
                } catch(error) {
                    alert("Errore durante la creazione del backup.");
                    console.error(error);
                }
            };

            const handleRestore = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        if (confirm("ATTENZIONE: i dati attuali verranno sovrascritti con quelli del file di backup. Continuare?")) {
                            const restoredData = JSON.parse(e.target.result);
                            if (restoredData.families && restoredData.visits && restoredData.reminders) {
                                setData(restoredData);
                                alert("Dati ripristinati con successo!");
                            } else {
                                alert("Il file di backup non sembra essere valido o è corrotto.");
                            }
                        }
                    } catch (error) {
                        alert("Errore durante la lettura del file di backup.");
                        console.error("Errore ripristino:", error);
                    }
                };
                reader.readAsText(file);
                event.target.value = null; 
            };
            
            const requestNotificationPermission = async () => {
                if (!('Notification' in window) || !navigator.serviceWorker) {
                    alert("Questo browser non supporta le notifiche push.");
                    return 'denied';
                }
                
                const permission = await Notification.requestPermission();
                
                if (permission === 'granted') {
                    console.log("Permesso per le notifiche concesso.");
                } else {
                    console.log("Permesso per le notifiche negato.");
                    alert("Le notifiche sono bloccate. Per riceverle, devi modificare le autorizzazioni per questo sito nelle impostazioni del tuo browser.");
                }
                return permission;
            };

            const sendTestNotification = async () => {
                let permission = Notification.permission;
                if (permission !== 'granted') {
                    permission = await requestNotificationPermission();
                }

                if (permission === 'granted') {
                    try {
                        const registration = await navigator.serviceWorker.ready;
                        await registration.showNotification("Notifica di Prova ✨", {
                            body: "Se vedi questo messaggio, le notifiche funzionano correttamente!",
                            icon: "./icons/icon-192x192.png",
                            tag: "test-notification"
                            // La riga 'badge' è stata rimossa per evitare l'errore 404
                        });
                    } catch (err) {
                        console.error("Errore nell'invio della notifica:", err);
                        alert("Si è verificato un errore durante l'invio della notifica di prova.");
                    }
                }
            };

            return (
                <div className="space-y-8">
                    <div className="bg-white p-6 rounded-lg shadow">
                        <h3 className="text-xl font-bold text-gray-800 mb-2 flex items-center"><Icon name="Bell" className="mr-3" />Notifiche Push</h3>
                        <p className="text-gray-600 mb-4">Abilita e testa le notifiche per ricevere avvisi su visite e promemoria imminenti.</p>
                        <button onClick={sendTestNotification} className="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 flex items-center">
                            Invia Notifica di Prova
                        </button>
                    </div>

                    <div className="bg-white p-6 rounded-lg shadow">
                        <h3 className="text-xl font-bold text-gray-800 mb-2 flex items-center"><Icon name="Download" className="mr-3" />Backup Dati</h3>
                        <p className="text-gray-600 mb-4">Salva una copia di sicurezza di tutti i dati della tua app in un singolo file.</p>
                        <button onClick={handleBackup} className="px-4 py-2 bg-[var(--brand-color)] text-white rounded-md hover:bg-[var(--brand-color-dark)] flex items-center">
                            Esegui Backup
                        </button>
                    </div>

                    <div className="bg-white p-6 rounded-lg shadow border-l-4 border-red-500">
                        <h3 className="text-xl font-bold text-gray-800 mb-2 flex items-center"><Icon name="DatabaseZap" className="mr-3 text-red-500" />Ripristino Dati da Backup</h3>
                        <p className="text-gray-600 mb-4">Carica un file di backup. <strong className="text-red-600">ATTENZIONE: i dati attuali verranno sovrascritti.</strong></p>
                        <input type="file" accept=".json" onChange={handleRestore} className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100"/>
                    </div>
                </div>
            );
        };
        
        const NotificationManager = ({ data }) => {
            const notifiedItems = useRef(new Set());

            const checkAndNotify = useCallback(async () => {
                if (Notification.permission !== "granted") {
                    return;
                }

                try {
                    const registration = await navigator.serviceWorker.ready;
                    const now = new Date();
                    const fiveMinutesFromNow = new Date(now.getTime() + 5 * 60 * 1000);

                    const upcomingItems = [
                        ...data.visits.filter(v => !v.completed),
                        ...data.reminders.filter(r => !r.completed)
                    ];

                    upcomingItems.forEach(item => {
                        const itemDate = new Date(item.date);
                        if (itemDate > now && itemDate <= fiveMinutesFromNow && !notifiedItems.current.has(item.id)) {
                            let title = '';
                            let body = '';
                            let tag = '';

                            if (item.familyName) { // È una visita
                                title = 'Visita Pastorale Imminente';
                                body = `Hai una visita con la ${item.familyName} alle ${itemDate.toLocaleTimeString('it-IT', {hour: '2-digit', minute:'2-digit'})}.`;
                                tag = `visit-${item.id}`;
                            } else { // È un promemoria
                                title = 'Promemoria Imminente';
                                body = item.text;
                                tag = `reminder-${item.id}`;
                            }
                            
                            registration.showNotification(title, { 
                                body, 
                                icon: './icons/icon-192x192.png',
                                tag: tag
                                // La riga 'badge' è stata rimossa per evitare l'errore 404
                            });
                            notifiedItems.current.add(item.id);
                        }
                    });
                } catch (err) {
                    console.error("Errore nel controllo delle notifiche:", err);
                }
            }, [data]);

            useEffect(() => {
                // Chiedi il permesso all'avvio se non è ancora stato concesso o negato
                if (Notification.permission === 'default') {
                    Notification.requestPermission();
                }

                const interval = setInterval(checkAndNotify, 60 * 1000); // Controlla ogni minuto
                return () => clearInterval(interval);
            }, [checkAndNotify]);

            return null;
        };

        const RichTextEditor = ({ value, onChange }) => {
            const quillRef = useRef(null);
            const editorRef = useRef(null);
        
            useEffect(() => {
                if (editorRef.current && !quillRef.current && window.Quill) {
                    quillRef.current = new window.Quill(editorRef.current, {
                        theme: 'snow',
                        modules: {
                             toolbar: [
                                ['bold', 'italic', 'underline'],
                                [{'list': 'ordered'}, {'list': 'bullet'}],
                                [{ 'background': ['yellow', 'lightgreen', 'lightblue', 'pink'] }],
                                ['clean']
                            ],
                        },
                    });
        
                    quillRef.current.on('text-change', (delta, oldDelta, source) => {
                        if (source === 'user') {
                            onChange(quillRef.current.root.innerHTML);
                        }
                    });
                }
            }, []);
        
            useEffect(() => {
                if (quillRef.current && quillRef.current.root.innerHTML !== value) {
                    quillRef.current.clipboard.dangerouslyPasteHTML(value || '');
                }
            }, [value]);
        
            return <div ref={editorRef} className="bg-white"></div>;
        };

        // --- FINE DEL CODICE APP ---

        // Renderizza l'app React nell'elemento root
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registrato con successo:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Registrazione del Service Worker fallita:', error);
                    });
            });
        }
    </script>
</body>
</html>